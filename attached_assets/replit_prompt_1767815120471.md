# Firewall365 - Prompt de InicializaÃ§Ã£o do Projeto

## ğŸ“Œ VisÃ£o Geral da AplicaÃ§Ã£o

**Nome:** Firewall365  
**URL:** app.firewall365.com.br  
**Objetivo:** GestÃ£o centralizada de dispositivos OPNSense com telemetria em tempo real  
**Arquitetura:** SaaS multi-tenant com agente agent em FreeBSD  

---

## ğŸ¯ Requisitos TÃ©cnicos Principais

### Stack TecnolÃ³gico
- **Backend:** Node.js + Express.js (ou Python Flask se preferir)
- **Frontend:** React com dashboard responsivo
- **Banco de Dados:** PostgreSQL (com migrations automÃ¡ticas)
- **ORM:** Sequelize ou Prisma
- **AutenticaÃ§Ã£o:** JWT + bcrypt
- **Deployment:** Ubuntu Linux no datacenter + Nginx + SSL autossignado

### Funcionalidades Core v1.0
1. **Multi-tenancy**
   - Criar tenants (clientes) com isolamento de dados
   - Suporte para mÃºltiplos usuÃ¡rios por tenant
   - Dashboard por tenant

2. **Gerenciamento de Firewalls**
   - Dispositivos OPNSense descobertos via agente
   - AlocaÃ§Ã£o dinÃ¢mica de firewall a tenant
   - Lista de firewalls ativos com status

3. **Telemetria e Monitoramento**
   - Receber mÃ©tricas do agente (CPU, memÃ³ria, uptime, interfaces)
   - Dashboard em tempo real com grÃ¡ficos
   - HistÃ³rico de 30 dias

4. **Agente FreeBSD**
   - Script Python que roda como serviÃ§o no OPNSense
   - Coleta dados via OPNSense REST API
   - Envia para app.firewall365.com.br via HTTPS

---

## ğŸ“ Estrutura de DiretÃ³rios Esperada

```
firewall365/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ models/           # Schemas de BD (User, Tenant, Firewall, Telemetry)
â”‚   â”‚   â”œâ”€â”€ routes/           # Rotas da API
â”‚   â”‚   â”œâ”€â”€ controllers/       # LÃ³gica de negÃ³cio
â”‚   â”‚   â”œâ”€â”€ middleware/        # Auth, validation, error handling
â”‚   â”‚   â”œâ”€â”€ services/          # ServiÃ§os de telemetria, tenant, firewall
â”‚   â”‚   â”œâ”€â”€ config/            # VariÃ¡veis de ambiente
â”‚   â”‚   â””â”€â”€ index.js           # Entry point
â”‚   â”œâ”€â”€ migrations/            # Scripts SQL de migraÃ§Ã£o
â”‚   â”œâ”€â”€ .env.example           # Template de variÃ¡veis
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/        # Components React (Dashboard, Tenant, Firewall)
â”‚   â”‚   â”œâ”€â”€ pages/             # PÃ¡ginas (Login, Dashboard, Tenants, Firewalls)
â”‚   â”‚   â”œâ”€â”€ services/          # Chamadas para API
â”‚   â”‚   â”œâ”€â”€ hooks/             # Custom hooks
â”‚   â”‚   â””â”€â”€ App.jsx
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ agent.py               # Agente Python para OPNSense
â”‚   â””â”€â”€ README.md              # InstruÃ§Ãµes de deployment
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ install.sh             # Script de instalaÃ§Ã£o Ubuntu + Nginx + SSL
â”‚   â””â”€â”€ init-db.sql            # Schema inicial do banco de dados
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ install_agent.md       # Guia passo a passo FreeBSD/OPNSense
â”‚   â”œâ”€â”€ API.md                 # DocumentaÃ§Ã£o da API
â”‚   â””â”€â”€ ARCHITECTURE.md        # Diagrama de arquitetura
â”‚
â”œâ”€â”€ docker-compose.yml         # Para dev local (opcional)
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md                  # VisÃ£o geral do projeto
```

---

## ğŸ”§ Detalhes do Script `install.sh`

O script deve executar no Ubuntu (20.04+) e realizar:

### PrÃ©-requisitos a Instalar
- `curl`, `wget`, `git`
- `nodejs` (v18+) e `npm`
- `postgresql` (v13+)
- `nginx` (latest)
- `python3` e `pip3` (para testes com agente)
- `openssl` (para gerar certificado SSL autossignado)

### ConfiguraÃ§Ãµes
1. **Criar usuÃ¡rio systemd** para rodar a aplicaÃ§Ã£o
2. **Clonar repositÃ³rio** do GitHub
3. **Instalar dependÃªncias** (npm install)
4. **Criar banco de dados PostgreSQL** e executar migrations
5. **Gerar certificado SSL autossignado** vÃ¡lido por 10 anos:
   ```bash
   openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
     -keyout /etc/nginx/ssl/firewall365.key \
     -out /etc/nginx/ssl/firewall365.crt \
     -subj "/CN=app.firewall365.com.br/O=Firewall365/C=BR"
   ```

6. **Configurar Nginx** como reverse proxy:
   - Listen em 443 (HTTPS)
   - Redirecionar HTTP â†’ HTTPS
   - Proxy para aplicaÃ§Ã£o local (ex: localhost:3000)
   - Configurar CORS se necessÃ¡rio

7. **Criar systemd service** para manter app rodando:
   - Arquivo: `/etc/systemd/system/firewall365.service`
   - Auto-restart on failure

8. **Build do frontend** (npm run build)

9. **Iniciar serviÃ§os** (nginx, postgresql, node)

10. **Validar instalaÃ§Ã£o** com curl

---

## ğŸ“‹ Detalhes do Documento `install_agent.md`

Deve conter instruÃ§Ãµes passo a passo:

### SeÃ§Ã£o 1: PrÃ©-requisitos
- Acesso SSH ao OPNSense/FreeBSD
- Credenciais de root ou sudo

### SeÃ§Ã£o 2: Gerar API Key no OPNSense
1. Acesse GUI do OPNSense
2. System â†’ API â†’ Users
3. Criar novo usuÃ¡rio para agent
4. Gerar chaves (key + secret)
5. Copiar e guardar com seguranÃ§a

### SeÃ§Ã£o 3: InstalaÃ§Ã£o do Agente
1. SSH no OPNSense
2. Instalar Python:
   ```bash
   pkg update && pkg install python39 py39-requests
   ```

3. Baixar script do agente:
   ```bash
   curl -O https://app.firewall365.com.br/agent/agent.py
   chmod +x agent.py
   sudo mv agent.py /usr/local/bin/firewall365-agent
   ```

4. Criar arquivo de configuraÃ§Ã£o:
   ```bash
   sudo nano /etc/firewall365/agent.conf
   ```
   ConteÃºdo:
   ```ini
   [opnsense]
   api_url = https://127.0.0.1/api
   api_key = YOUR_KEY_HERE
   api_secret = YOUR_SECRET_HERE
   
   [app]
   endpoint = https://app.firewall365.com.br/api/telemetry
   bearer_token = YOUR_AGENT_TOKEN_HERE
   ```

5. Criar startup script em `/usr/local/etc/rc.d/firewall365-agent.sh`
6. Habilitar: `sysrc firewall365_agent_enable=YES`
7. Iniciar: `service firewall365-agent start`
8. Verificar logs: `tail -f /var/log/firewall365-agent.log`

### SeÃ§Ã£o 4: ValidaÃ§Ã£o
- Testar conectividade com agente
- Verificar primeiro envio de telemetria
- Confirmar aparecimento do firewall no dashboard

---

## ğŸŒ Endpoints da API Backend

### AutenticaÃ§Ã£o
```
POST   /api/auth/register          # Registro de usuÃ¡rio
POST   /api/auth/login             # Login (retorna JWT)
POST   /api/auth/refresh           # Refresh token
```

### Tenants
```
POST   /api/tenants                # Criar novo tenant
GET    /api/tenants                # Listar tenants do usuÃ¡rio
GET    /api/tenants/:id            # Detalhe de tenant
PUT    /api/tenants/:id            # Editar tenant
DELETE /api/tenants/:id            # Deletar tenant
```

### Firewalls
```
GET    /api/firewalls              # Listar firewalls (por tenant)
POST   /api/firewalls/:id/assign   # Alocar firewall a tenant
GET    /api/firewalls/:id/telemetry # HistÃ³rico de telemetria
```

### Telemetria (Agente)
```
POST   /api/telemetry              # Receber dados do agente
GET    /api/telemetry/:firewallId  # HistÃ³rico
```

### Sistema
```
GET    /api/health                 # Health check da API
GET    /api/config                 # ConfiguraÃ§Ãµes pÃºblicas
```

---

## ğŸ” SeguranÃ§a

### VariÃ¡veis de Ambiente (.env)
```
DATABASE_URL=postgresql://user:pass@localhost/firewall365
JWT_SECRET=seu_secret_super_seguro_aqui
AGENT_SECRET=secret_para_validar_agente
NODE_ENV=production
APP_URL=https://app.firewall365.com.br
NGINX_SSL_CERT=/etc/nginx/ssl/firewall365.crt
NGINX_SSL_KEY=/etc/nginx/ssl/firewall365.key
```

### AutenticaÃ§Ã£o Agente
- Bearer token ou API Key especÃ­fica por tenant
- Validar certificado SSL (ou aceitar auto-signed em env dev)
- Rate limiting por IP/token

---

## ğŸ¨ Dashboard - Componentes Principais

### Layout
- **Header:** Logo, usuÃ¡rio logged, botÃ£o logout
- **Sidebar:** Menu navegaÃ§Ã£o (Dashboard, Tenants, Firewalls)

### PÃ¡ginas
1. **Dashboard Principal**
   - Cards de status (total firewalls, tenants, alertas)
   - GrÃ¡fico de uptime consolidado
   - Ãšltimas telemetrias

2. **Tenants**
   - Tabela de tenants criados
   - BotÃ£o "Criar Tenant"
   - Editar/deletar tenant

3. **Firewalls**
   - Tabela de firewalls descobertos
   - Status (Online/Offline)
   - AÃ§Ã£o "Alocar a Tenant"
   - GrÃ¡ficos de telemetria

---

## ğŸ“Š Schema Inicial do Banco de Dados

### Tabelas Principais
```sql
-- Users
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tenants
CREATE TABLE tenants (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  owner_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Firewalls
CREATE TABLE firewalls (
  id UUID PRIMARY KEY,
  serial_number VARCHAR(255) UNIQUE NOT NULL,
  hostname VARCHAR(255),
  tenant_id UUID REFERENCES tenants(id),
  status VARCHAR(50) DEFAULT 'pending',
  last_seen TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Telemetry
CREATE TABLE telemetry (
  id UUID PRIMARY KEY,
  firewall_id UUID REFERENCES firewalls(id),
  cpu_usage FLOAT,
  memory_usage FLOAT,
  uptime_seconds BIGINT,
  interfaces_json JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  INDEX (firewall_id, created_at)
);

-- API Tokens for Agents
CREATE TABLE api_tokens (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  token_hash VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸš€ Fase de ImplementaÃ§Ã£o

### Sprint 1: Setup e AutenticaÃ§Ã£o
- [ ] Estrutura base em Replit
- [ ] Database setup
- [ ] Auth (register/login)
- [ ] Script install.sh funcional

### Sprint 2: API de Tenants e Firewalls
- [ ] CRUD de tenants
- [ ] Endpoint de telemetria
- [ ] Descoberta de firewalls
- [ ] AlocaÃ§Ã£o de firewall a tenant

### Sprint 3: Frontend
- [ ] Login
- [ ] Dashboard principal
- [ ] Gerenciamento de tenants
- [ ] Gerenciamento de firewalls

### Sprint 4: Agente
- [ ] Script agente em Python
- [ ] DocumentaÃ§Ã£o install_agent.md
- [ ] Testes de comunicaÃ§Ã£o

### Sprint 5: Deployment e Deploy
- [ ] Testes de install.sh
- [ ] Deploy em Ubuntu
- [ ] ValidaÃ§Ã£o ponta a ponta

---

## ğŸ“ EspecificaÃ§Ãµes Finais

**Replit:** Ambiente de desenvolvimento com acesso ao git  
**GitHub:** RepositÃ³rio privado para versionamento  
**Deploy:** Ubuntu no seu datacenter com script install.sh  
**SSL:** Certificado autossignado por 10 anos  
**Banco:** PostgreSQL local no Ubuntu  
**Scaling:** Multi-tenant desde o inÃ­cio  

---

## âœ… Checklist Inicial

- [ ] Criar repositÃ³rio GitHub
- [ ] Clonar em Replit
- [ ] Gerar estrutura de pastas
- [ ] Criar package.json base
- [ ] Iniciar git tracking
- [ ] Criar branch develop
- [ ] Documentar progress em README.md

**PrÃ³ximo passo:** Iniciar com setup de banco de dados e autenticaÃ§Ã£o bÃ¡sica.
